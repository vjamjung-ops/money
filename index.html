<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Money Tracker - บันทึกรายรับรายจ่าย</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .category-btn {
            transition: all 0.3s ease;
        }

        .category-btn:hover {
            transform: translateY(-2px);
        }

        .category-btn.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .transaction-item {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .calendar-day {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .calendar-day:hover {
            transform: scale(1.1);
        }

        .calendar-day.has-transaction {
            background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%);
            color: white;
            font-weight: bold;
        }

        .calendar-day.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .calendar-day.range-selected {
            background: linear-gradient(135deg, #c084fc 0%, #a855f7 100%);
            color: white;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
            }
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            border-radius: 15px;
            padding: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen pb-20">
        <!-- Header with Statistics -->
        <div class="glass-effect mx-4 mt-4 p-4 mb-4">
            <h1 class="text-2xl font-bold text-center text-gray-800 mb-4">
                <i class="fas fa-wallet mr-2"></i>Money Tracker
            </h1>
            
            <!-- Connection Status -->
            <div id="connectionStatus" class="text-center text-xs mb-2">
                <span class="text-gray-500">● ออฟไลน์ (บันทึกในเครื่อง)</span>
            </div>
            
            <!-- Statistics Grid -->
            <div class="grid grid-cols-3 gap-3">
                <!-- Income -->
                <div class="stat-card text-center">
                    <div class="text-green-600 mb-1">
                        <i class="fas fa-arrow-down text-lg"></i>
                    </div>
                    <div class="text-xs text-gray-600 mb-1">รายรับ</div>
                    <div id="totalIncome" class="text-lg font-bold text-green-600">฿0</div>
                </div>
                
                <!-- Expense -->
                <div class="stat-card text-center">
                    <div class="text-red-600 mb-1">
                        <i class="fas fa-arrow-up text-lg"></i>
                    </div>
                    <div class="text-xs text-gray-600 mb-1">รายจ่าย</div>
                    <div id="totalExpense" class="text-lg font-bold text-red-600">฿0</div>
                </div>
                
                <!-- Balance -->
                <div class="stat-card text-center">
                    <div class="text-purple-600 mb-1">
                        <i class="fas fa-coins text-lg"></i>
                    </div>
                    <div class="text-xs text-gray-600 mb-1">คงเหลือ</div>
                    <div id="balance" class="text-lg font-bold">฿0</div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="flex justify-center mb-4 mx-4">
            <button onclick="switchTab('add')" class="tab-btn active flex-1 py-3 px-4 rounded-l-xl font-semibold transition-all">
                <i class="fas fa-plus-circle mr-2"></i>เพิ่มรายการ
            </button>
            <button onclick="switchTab('history')" class="tab-btn flex-1 py-3 px-4 rounded-r-xl font-semibold bg-white text-gray-700 transition-all">
                <i class="fas fa-calendar-alt mr-2"></i>ประวัติ
            </button>
        </div>

        <!-- Add Transaction Tab -->
        <div id="addTab" class="mx-4">
            <div class="glass-effect p-6">
                <!-- Type Selection -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-bold mb-3">ประเภทรายการ</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="selectType('income')" id="incomeBtn" class="category-btn bg-green-100 text-green-700 py-3 px-4 rounded-xl font-semibold">
                            <i class="fas fa-arrow-down mr-2"></i>รายรับ
                        </button>
                        <button onclick="selectType('expense')" id="expenseBtn" class="category-btn bg-red-100 text-red-700 py-3 px-4 rounded-xl font-semibold">
                            <i class="fas fa-arrow-up mr-2"></i>รายจ่าย
                        </button>
                    </div>
                </div>

                <!-- Category Selection (for expenses) -->
                <div id="categorySection" class="mb-6 hidden">
                    <label class="block text-gray-700 font-bold mb-3">หมวดหมู่ <span class="text-red-500">*</span></label>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="selectCategory('food')" class="category-btn bg-yellow-100 text-yellow-700 py-3 px-4 rounded-xl">
                            <i class="fas fa-utensils mr-2"></i>อาหาร
                        </button>
                        <button onclick="selectCategory('necessities')" class="category-btn bg-blue-100 text-blue-700 py-3 px-4 rounded-xl">
                            <i class="fas fa-home mr-2"></i>ของใช้จำเป็น
                        </button>
                        <button onclick="selectCategory('shopping')" class="category-btn bg-pink-100 text-pink-700 py-3 px-4 rounded-xl">
                            <i class="fas fa-shopping-bag mr-2"></i>ช้อปปิ้ง
                        </button>
                        <button onclick="selectCategory('others')" class="category-btn bg-gray-100 text-gray-700 py-3 px-4 rounded-xl">
                            <i class="fas fa-ellipsis-h mr-2"></i>อื่นๆ
                        </button>
                    </div>
                </div>

                <!-- Amount Input -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-bold mb-2">จำนวนเงิน <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500">฿</span>
                        <input type="number" id="amount" placeholder="0.00" class="w-full pl-10 pr-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none text-lg">
                    </div>
                </div>

                <!-- Description Input -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-bold mb-2">รายละเอียด (ไม่บังคับ)</label>
                    <textarea id="description" placeholder="ใส่รายละเอียดเพิ่มเติม..." class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none" rows="3"></textarea>
                </div>

                <!-- Save Button -->
                <button onclick="saveTransaction()" id="saveBtn" class="w-full bg-gradient-to-r from-purple-500 to-purple-700 text-white py-4 rounded-xl font-bold text-lg hover:from-purple-600 hover:to-purple-800 transition-all pulse-animation">
                    <i class="fas fa-save mr-2"></i>บันทึกรายการ
                </button>
            </div>
        </div>

        <!-- History Tab -->
        <div id="historyTab" class="mx-4 hidden">
            <div class="glass-effect p-4">
                <!-- Month Navigation -->
                <div class="flex justify-between items-center mb-4">
                    <button onclick="changeMonth(-1)" class="text-purple-600 hover:text-purple-800">
                        <i class="fas fa-chevron-left text-2xl"></i>
                    </button>
                    <h3 id="currentMonth" class="text-xl font-bold text-gray-800"></h3>
                    <button onclick="changeMonth(1)" class="text-purple-600 hover:text-purple-800">
                        <i class="fas fa-chevron-right text-2xl"></i>
                    </button>
                </div>

                <!-- Selection Mode Toggle -->
                <div class="mb-4 flex justify-between items-center">
                    <button onclick="toggleSelectionMode()" id="selectionModeBtn" class="bg-purple-100 text-purple-700 px-4 py-2 rounded-lg font-semibold text-sm">
                        <i class="fas fa-check-square mr-2"></i>เลือกหลายวัน
                    </button>
                    <button onclick="clearSelection()" class="text-gray-500 text-sm hover:text-gray-700">
                        <i class="fas fa-times-circle mr-1"></i>ล้างที่เลือก
                    </button>
                </div>

                <!-- Calendar Grid -->
                <div id="calendar" class="grid grid-cols-7 gap-2 mb-4">
                    <!-- Calendar will be populated by JavaScript -->
                </div>

                <!-- Date Range Summary -->
                <div id="rangeSummary" class="mt-4 p-4 bg-purple-50 rounded-xl hidden">
                    <h4 class="font-bold text-gray-800 mb-2">
                        <i class="fas fa-calendar-week mr-2"></i>สรุปช่วงเวลาที่เลือก
                    </h4>
                    <div class="text-sm text-gray-600 mb-3">
                        <span id="selectedRange"></span>
                    </div>
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-green-600">รายรับรวม:</span>
                            <span id="rangeIncome" class="font-semibold text-green-600">฿0.00</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-red-600">รายจ่ายรวม:</span>
                            <span id="rangeExpense" class="font-semibold text-red-600">฿0.00</span>
                        </div>
                        <hr class="border-gray-300">
                        <div class="flex justify-between font-bold">
                            <span>สุทธิ:</span>
                            <span id="rangeNet">฿0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Transaction List -->
                <div id="transactionList" class="mt-4 space-y-2 max-h-64 overflow-y-auto">
                    <!-- Transactions will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============= Configuration =============
        // ใส่ค่า Supabase ของคุณที่นี่
        const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // เช่น https://xxxxx.supabase.co
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; // เช่น eyJhbGc...
        
        // ============= Global Variables =============
        let transactions = [];
        let selectedType = '';
        let selectedCategory = '';
        let currentDate = new Date();
        let selectedDates = new Set();
        let selectionMode = false;
        let supabase = null;
        let isOnline = false;

        const categoryIcons = {
            food: 'fa-utensils',
            necessities: 'fa-home',
            shopping: 'fa-shopping-bag',
            others: 'fa-ellipsis-h',
            income: 'fa-arrow-down'
        };

        const categoryNames = {
            food: 'อาหาร',
            necessities: 'ของใช้จำเป็น',
            shopping: 'ช้อปปิ้ง',
            others: 'อื่นๆ',
            income: 'รายรับ'
        };

        // ============= Supabase Functions =============
        function initSupabase() {
            if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_ANON_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
                try {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    isOnline = true;
                    updateConnectionStatus(true);
                    console.log('Supabase connected successfully');
                } catch (error) {
                    console.error('Supabase connection error:', error);
                    isOnline = false;
                    updateConnectionStatus(false);
                }
            } else {
                console.log('Using local storage only (Supabase not configured)');
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(online) {
            const statusEl = document.getElementById('connectionStatus');
            if (online) {
                statusEl.innerHTML = '<span class="text-green-500">● ออนไลน์ (Supabase)</span>';
            } else {
                statusEl.innerHTML = '<span class="text-gray-500">● ออฟไลน์ (บันทึกในเครื่อง)</span>';
            }
        }

        function getUserId() {
            let userId = localStorage.getItem('userId');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('userId', userId);
            }
            return userId;
        }

        async function saveToSupabase(transaction) {
            if (!supabase || !isOnline) return null;
            
            try {
                const { data, error } = await supabase
                    .from('transactions')
                    .insert([{
                        ...transaction,
                        user_id: getUserId()
                    }])
                    .select();
                
                if (error) throw error;
                return data[0];
            } catch (error) {
                console.error('Error saving to Supabase:', error);
                return null;
            }
        }

        async function loadFromSupabase() {
            if (!supabase || !isOnline) return [];
            
            try {
                const { data, error } = await supabase
                    .from('transactions')
                    .select('*')
                    .eq('user_id', getUserId())
                    .order('date', { ascending: false });
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Error loading from Supabase:', error);
                return [];
            }
        }

        // ============= UI Functions =============
        function switchTab(tab) {
            const addTab = document.getElementById('addTab');
            const historyTab = document.getElementById('historyTab');
            const tabs = document.querySelectorAll('.tab-btn');
            
            tabs.forEach(t => t.classList.remove('active', 'bg-white', 'text-gray-700'));
            
            if (tab === 'add') {
                addTab.classList.remove('hidden');
                historyTab.classList.add('hidden');
                tabs[0].classList.add('active');
                tabs[1].classList.add('bg-white', 'text-gray-700');
            } else {
                addTab.classList.add('hidden');
                historyTab.classList.remove('hidden');
                tabs[1].classList.add('active');
                tabs[0].classList.add('bg-white', 'text-gray-700');
                renderCalendar();
            }
        }

        function selectType(type) {
            selectedType = type;
            const incomeBtn = document.getElementById('incomeBtn');
            const expenseBtn = document.getElementById('expenseBtn');
            const categorySection = document.getElementById('categorySection');
            
            incomeBtn.classList.remove('selected');
            expenseBtn.classList.remove('selected');
            
            if (type === 'income') {
                incomeBtn.classList.add('selected');
                categorySection.classList.add('hidden');
                selectedCategory = 'income';
            } else {
                expenseBtn.classList.add('selected');
                categorySection.classList.remove('hidden');
                selectedCategory = '';
            }
        }

        function selectCategory(category) {
            selectedCategory = category;
            const buttons = document.querySelectorAll('#categorySection .category-btn');
            buttons.forEach(btn => btn.classList.remove('selected'));
            event.target.closest('button').classList.add('selected');
        }

        async function saveTransaction() {
            const amountInput = document.getElementById('amount');
            const descriptionInput = document.getElementById('description');
            const saveBtn = document.getElementById('saveBtn');
            
            const amount = parseFloat(amountInput.value);
            const description = descriptionInput.value.trim();
            
            // Validation
            if (!selectedType) {
                alert('กรุณาเลือกประเภทรายการ');
                return;
            }
            
            if (selectedType === 'expense' && !selectedCategory) {
                alert('กรุณาเลือกหมวดหมู่รายจ่าย');
                return;
            }
            
            if (!amount || amount <= 0) {
                alert('กรุณาใส่จำนวนเงิน');
                return;
            }
            
            // Show loading state
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>กำลังบันทึก...';
            
            try {
                const transaction = {
                    id: Date.now(),
                    type: selectedType,
                    category: selectedCategory,
                    amount: amount,
                    description: description,
                    date: new Date().toISOString()
                };
                
                // Try to save to Supabase first
                const supabaseResult = await saveToSupabase(transaction);
                if (supabaseResult) {
                    transaction.id = supabaseResult.id;
                }
                
                // Always save to localStorage as backup
                transactions.push(transaction);
                localStorage.setItem('transactions', JSON.stringify(transactions));
                
                // Reset form
                amountInput.value = '';
                descriptionInput.value = '';
                selectedType = '';
                selectedCategory = '';
                document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('selected'));
                document.getElementById('categorySection').classList.add('hidden');
                
                updateBalance();
                
                // Show success message
                alert('บันทึกรายการสำเร็จ!');
                
            } catch (error) {
                console.error('Error saving transaction:', error);
                alert('เกิดข้อผิดพลาด กรุณาลองใหม่');
            } finally {
                // Reset button state
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>บันทึกรายการ';
            }
        }

        function updateBalance() {
            const income = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const balance = income - expense;
            
            document.getElementById('totalIncome').textContent = `฿${income.toLocaleString('th-TH', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            document.getElementById('totalExpense').textContent = `฿${expense.toLocaleString('th-TH', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            document.getElementById('balance').textContent = `฿${balance.toLocaleString('th-TH', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`;
            document.getElementById('balance').style.color = balance >= 0 ? '#10b981' : '#ef4444';
        }

        function toggleSelectionMode() {
            selectionMode = !selectionMode;
            const btn = document.getElementById('selectionModeBtn');
            
            if (selectionMode) {
                btn.classList.add('bg-purple-600', 'text-white');
                btn.classList.remove('bg-purple-100', 'text-purple-700');
                btn.innerHTML = '<i class="fas fa-check-square mr-2"></i>กำลังเลือก...';
            } else {
                btn.classList.remove('bg-purple-600', 'text-white');
                btn.classList.add('bg-purple-100', 'text-purple-700');
                btn.innerHTML = '<i class="fas fa-check-square mr-2"></i>เลือกหลายวัน';
            }
            
            clearSelection();
        }

        function clearSelection() {
            selectedDates.clear();
            renderCalendar();
            document.getElementById('rangeSummary').classList.add('hidden');
            document.getElementById('transactionList').innerHTML = '';
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            clearSelection();
            renderCalendar();
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            document.getElementById('currentMonth').textContent = 
                new Date(year, month).toLocaleDateString('th-TH', { year: 'numeric', month: 'long' });
            
            const calendar = document.getElementById('calendar');
            calendar.innerHTML = '';
            
            // Day headers
            const dayHeaders = ['อา', 'จ', 'อ', 'พ', 'พฤ', 'ศ', 'ส'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'text-center text-xs font-bold text-gray-600';
                header.textContent = day;
                calendar.appendChild(header);
            });
            
            // Empty cells
            for (let i = 0; i < firstDay; i++) {
                calendar.appendChild(document.createElement('div'));
            }
            
            // Days
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('button');
                dayEl.className = 'calendar-day p-2 text-center rounded-lg bg-white border border-gray-200';
                dayEl.textContent = day;
                
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayTransactions = transactions.filter(t => t.date.startsWith(dateStr));
                
                if (dayTransactions.length > 0 && !selectedDates.has(dateStr)) {
                    dayEl.classList.add('has-transaction');
                }
                
                if (selectedDates.has(dateStr)) {
                    dayEl.classList.add('selected');
                }
                
                dayEl.onclick = () => handleDayClick(dateStr);
                calendar.appendChild(dayEl);
            }
        }

        function handleDayClick(dateStr) {
            if (selectionMode) {
                if (selectedDates.has(dateStr)) {
                    selectedDates.delete(dateStr);
                } else {
                    selectedDates.add(dateStr);
                }
                renderCalendar();
                showRangeTransactions();
            } else {
                selectedDates.clear();
                selectedDates.add(dateStr);
                renderCalendar();
                showDayTransactions(dateStr);
            }
        }

        function showRangeTransactions() {
            if (selectedDates.size === 0) {
                document.getElementById('rangeSummary').classList.add('hidden');
                document.getElementById('transactionList').innerHTML = '';
                return;
            }

            const sortedDates = Array.from(selectedDates).sort();
            const rangeTransactions = transactions.filter(t => {
                const tDate = t.date.split('T')[0];
                return selectedDates.has(tDate);
            });

            const rangeSummary = document.getElementById('rangeSummary');
            rangeSummary.classList.remove('hidden');

            // Format date range
            const firstDate = new Date(sortedDates[0]).toLocaleDateString('th-TH');
            const lastDate = new Date(sortedDates[sortedDates.length - 1]).toLocaleDateString('th-TH');
            const rangeText = sortedDates.length === 1 ? firstDate : `${firstDate} - ${lastDate}`;
            document.getElementById('selectedRange').textContent = `${rangeText} (${selectedDates.size} วัน)`;

            // Calculate totals
            const rangeIncome = rangeTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const rangeExpense = rangeTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const rangeNet = rangeIncome - rangeExpense;

            document.getElementById('rangeIncome').textContent = `฿${rangeIncome.toLocaleString('th-TH', {minimumFractionDigits: 2})}`;
            document.getElementById('rangeExpense').textContent = `฿${rangeExpense.toLocaleString('th-TH', {minimumFractionDigits: 2})}`;
            document.getElementById('rangeNet').textContent = `฿${rangeNet.toLocaleString('th-TH', {minimumFractionDigits: 2})}`;
            document.getElementById('rangeNet').style.color = rangeNet >= 0 ? '#10b981' : '#ef4444';

            // Show transactions
            const transactionList = document.getElementById('transactionList');
            transactionList.innerHTML = '';

            if (rangeTransactions.length === 0) {
                transactionList.innerHTML = '<p class="text-center text-gray-500 py-4">ไม่มีรายการในช่วงเวลาที่เลือก</p>';
                return;
            }

            // Group by date
            const groupedTransactions = {};
            rangeTransactions.forEach(t => {
                const date = t.date.split('T')[0];
                if (!groupedTransactions[date]) {
                    groupedTransactions[date] = [];
                }
                groupedTransactions[date].push(t);
            });

            // Display grouped transactions
            sortedDates.forEach(date => {
                if (groupedTransactions[date]) {
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'font-bold text-gray-700 mt-3 mb-2';
                    dateHeader.textContent = new Date(date).toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'long' });
                    transactionList.appendChild(dateHeader);

                    groupedTransactions[date].forEach(t => {
                        const item = createTransactionElement(t);
                        transactionList.appendChild(item);
                    });
                }
            });
        }

        function showDayTransactions(dateStr) {
            const dayTransactions = transactions.filter(t => t.date.startsWith(dateStr));
            const rangeSummary = document.getElementById('rangeSummary');
            rangeSummary.classList.remove('hidden');

            // Update title and date
            document.getElementById('selectedRange').textContent = new Date(dateStr).toLocaleDateString('th-TH', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });

            const dailyIncome = dayTransactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const dailyExpense = dayTransactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
            const dailyNet = dailyIncome - dailyExpense;

            document.getElementById('rangeIncome').textContent = `฿${dailyIncome.toLocaleString('th-TH', {minimumFractionDigits: 2})}`;
            document.getElementById('rangeExpense').textContent = `฿${dailyExpense.toLocaleString('th-TH', {minimumFractionDigits: 2})}`;
            document.getElementById('rangeNet').textContent = `฿${dailyNet.toLocaleString('th-TH', {minimumFractionDigits: 2})}`;
            document.getElementById('rangeNet').style.color = dailyNet >= 0 ? '#10b981' : '#ef4444';

            const transactionList = document.getElementById('transactionList');
            transactionList.innerHTML = '';

            if (dayTransactions.length === 0) {
                transactionList.innerHTML = '<p class="text-center text-gray-500 py-4">ไม่มีรายการในวันนี้</p>';
                return;
            }

            dayTransactions.forEach(t => {
                const item = createTransactionElement(t);
                transactionList.appendChild(item);
            });
        }

        function createTransactionElement(transaction) {
            const item = document.createElement('div');
            item.className = 'transaction-item bg-white p-3 rounded-lg border border-gray-200';
            
            const icon = categoryIcons[transaction.category] || 'fa-circle';
            const categoryName = categoryNames[transaction.category] || '';
            const amountColor = transaction.type === 'income' ? 'text-green-600' : 'text-red-600';
            const amountSign = transaction.type === 'income' ? '+' : '-';
            
            item.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex items-start">
                        <i class="fas ${icon} ${amountColor} mt-1 mr-3"></i>
                        <div>
                            <div class="font-semibold text-gray-800">${categoryName}</div>
                            ${transaction.description ? `<div class="text-sm text-gray-500">${transaction.description}</div>` : ''}
                            <div class="text-xs text-gray-400">${new Date(transaction.date).toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'})}</div>
                        </div>
                    </div>
                    <div class="${amountColor} font-bold">
                        ${amountSign}฿${transaction.amount.toLocaleString('th-TH', {minimumFractionDigits: 2})}
                    </div>
                </div>
            `;
            
            return item;
        }

        // ============= Initialization =============
        async function loadTransactions() {
            // Try to load from Supabase first
            const supabaseData = await loadFromSupabase();
            
            if (supabaseData.length > 0) {
                transactions = supabaseData;
                localStorage.setItem('transactions', JSON.stringify(transactions));
            } else {
                // Fall back to localStorage
                transactions = JSON.parse(localStorage.getItem('transactions')) || [];
            }
            
            updateBalance();
            renderCalendar();
        }

        // Initialize when page loads
        window.addEventListener('DOMContentLoaded', async () => {
            initSupabase();
            await loadTransactions();
        });
    </script>
</body>
</html>